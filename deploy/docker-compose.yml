# ============================================
# 艺术导航 - Docker Compose 生产配置
# 适用于: 阿里云 ECS 2C2G
# ============================================

version: '3.8'

services:
  # Next.js 应用服务
  nextjs:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: artistic-nav-app
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    env_file:
      - .env
    volumes:
      # 数据持久化 - SQLite 数据库
      - ./data:/app/data
      # 上传文件存储
      - ./uploads:/app/public/uploads
      # 日志目录
      - ./logs:/app/logs
    networks:
      - artistic-nav-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          # 限制最大使用 1.5G 内存
          cpus: '1.5'
          memory: 1.5G
        reservations:
          # 预留基础资源
          cpus: '0.5'
          memory: 256M

  # MySQL 数据库 (可选，需要更多内存)
  # 如果 DB_PROVIDER=sqlite，可以注释掉此服务
  # mysql:
  #   image: mysql:8.0
  #   container_name: artistic-nav-mysql
  #   restart: unless-stopped
  #   environment:
  #     MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-change_me_root_123}
  #     MYSQL_DATABASE: artistic_nav
  #     MYSQL_USER: navuser
  #     MYSQL_PASSWORD: ${MYSQL_USER_PASSWORD:-change_me_user_123}
  #   volumes:
  #     - mysql-data:/var/lib/mysql
  #     - ./init/mysql:/docker-entrypoint-initdb.d
  #   networks:
  #     - artistic-nav-network
  #   command: 
  #     --default-authentication-plugin=mysql_native_password
  #     --character-set-server=utf8mb4
  #     --collation-server=utf8mb4_unicode_ci
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '0.5'
  #         memory: 512M

networks:
  artistic-nav-network:
    driver: bridge

volumes:
  mysql-data:
    driver: local
