version: '3.8'

services:
  artistic-nav:
    container_name: artistic-nav
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    restart: always
    
    # ç«¯å£æ˜ å°„
    ports:
      - "3000:3000"
    
    # èµ„æºé™åˆ¶ï¼ˆ2C2G ä¼˜åŒ–ï¼‰
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1.5G
        reservations:
          cpus: '0.5'
          memory: 512M
    
    # å®‰å…¨é€‰é¡¹
    security_opt:
      - no-new-privileges:true
    
    # åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ
    read_only: true
    
    # ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿ
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
      - /app/.next/cache:size=50m
    
    environment:
      # ç”Ÿäº§çŽ¯å¢ƒ
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
      
      # æ•°æ®åº“
      - DB_PROVIDER=sqlite
      - DATABASE_URL=file:./prisma/dev.db
      
      # å®‰å…¨
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      
      # å­˜å‚¨
      - STORAGE_TYPE=${STORAGE_TYPE:-local}
      
      # OSS é…ç½®ï¼ˆå¯é€‰ï¼‰
      - OSS_REGION=${OSS_REGION:-}
      - OSS_ACCESS_KEY_ID=${OSS_ACCESS_KEY_ID:-}
      - OSS_ACCESS_KEY_SECRET=${OSS_ACCESS_KEY_SECRET:-}
      - OSS_BUCKET=${OSS_BUCKET:-}
      - OSS_ENDPOINT=${OSS_ENDPOINT:-}
    
    volumes:
      # æ•°æ®åº“æŒä¹…åŒ–
      - type: bind
        source: ../prisma/dev.db
        target: /app/prisma/dev.db
      
      # ä¸Šä¼ æ–‡ä»¶æŒä¹…åŒ–
      - type: bind
        source: ../public/uploads
        target: /app/public/uploads
      
      # ä¸´æ—¶ç›®å½•ï¼ˆå¯å†™ï¼‰
      - type: tmpfs
        target: /tmp
        tmpfs:
          size: 100M
    
    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # å¯åŠ¨å‘½ä»¤
    command: >
      sh -c "
        echo 'ðŸ” Security: Running as non-root user' &&
        echo 'ðŸ”§ Initializing database...' &&
        npx prisma db push --accept-data-loss 2>/dev/null || true &&
        echo 'ðŸš€ Starting application...' &&
        exec node server.js
      "
    
    # ç½‘ç»œéš”ç¦»
    networks:
      - artistic-nav-net

networks:
  artistic-nav-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
